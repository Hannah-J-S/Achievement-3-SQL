### FInd the average amount paid by the top 5 customers

SELECT AVG (total_amount_paid) AS avg_amount_paid_top_five_customers
FROM
(SELECT SUM(pmt.amount) AS total_amount_paid
    FROM payment AS pmt
    INNER JOIN customer AS cust1 ON pmt.customer_id = cust1.customer_id
    INNER JOIN address AS addr1 ON cust1.address_id = addr1.address_id
    INNER JOIN city AS cty1 ON addr1.city_id = cty1.city_id
    INNER JOIN country AS cnt1 ON cty1.country_id = cnt1.country_id
    WHERE cty1.city IN
        (SELECT cty2.city
        FROM customer AS cust2
        INNER JOIN address AS addr2 ON cust2.address_id = addr2.address_id
        INNER JOIN city AS cty2 ON addr2.city_id = cty2.city_id
        INNER JOIN country AS cnt2 ON cty2.country_id = cnt2.country_id
        WHERE cnt2.country IN
            (SELECT cnt3.country
            FROM customer AS cust3
            INNER JOIN address AS addr3 ON cust3.address_id = addr3.address_id
            INNER JOIN city AS cty3 ON addr3.city_id = cty3.city_id
            INNER JOIN country AS cnt3 ON cty3.country_id = cnt3.country_id
            GROUP BY cnt3.country
            ORDER BY COUNT(cust3.customer_id) DESC
            LIMIT 10)
        GROUP BY cty2.city
        ORDER BY COUNT(cust2.customer_id) DESC
        LIMIT 10)
    GROUP BY cust1.customer_id
    ORDER BY total_amount_paid DESC
LIMIT 5) AS average;
